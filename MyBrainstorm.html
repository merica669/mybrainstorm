<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyBrainstorm.ai - Your AI Academic Partner</title>
    <meta name="description" content="An academic and educational AI tool to help students brainstorm ideas, structure arguments, and understand complex topics. Features a free prompt generator and a Pro AI Tutor.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6; /* Blue */
            --primary-dark: #2563eb;
            --secondary: #10b981; /* Green */
            --background: #f3f4f6; /* Light Gray */
            --surface: #ffffff;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
        }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .gradient-text {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .hero-gradient { background: var(--gradient); }
        .step.active { display: block; }
        .step { display: none; }
        .response-text p { margin-bottom: 1rem; }
        .response-text ul { list-style-type: disc; list-style-position: inside; margin-left: 1rem; margin-bottom: 1rem; }
        .response-text li { margin-bottom: 0.5rem; }
        .loader-dots div { animation: bounce 1.4s infinite ease-in-out both; }
        .loader-dots .dot1 { animation-delay: -0.32s; }
        .loader-dots .dot2 { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .nav-link.active {
            color: var(--primary);
            font-weight: 700;
        }
        .prompt-cue-card {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-lg border-b border-gray-200 fixed top-0 left-0 right-0 z-40">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-4">
            <a href="#" onclick="showPage('home')" class="text-2xl font-extrabold gradient-text flex items-center gap-2">
                <span class="text-3xl">💡</span> MyBrainstorm.ai
            </a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="#" id="nav-home" class="nav-link text-gray-600 hover:text-blue-600 transition-colors" onclick="showPage('home')">Home</a>
                <a href="#" id="nav-tutor" class="nav-link text-gray-600 hover:text-blue-600 transition-colors" onclick="showPage('tutor')">AI Tutor</a>
                <a href="#" id="nav-university" class="nav-link text-gray-600 hover:text-blue-600 transition-colors" onclick="showPage('university')">Prompt University</a>
                <a href="#" id="nav-hall" class="nav-link text-gray-600 hover:text-blue-600 transition-colors" onclick="showPage('hall')">Study Hall</a>
            </div>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-transform transform hover:scale-105" onclick="showOnboarding()">
                My Profile
            </button>
        </nav>
    </header>

    <main class="pt-20">

        <!-- Home Page -->
        <div id="homePage" class="page-content">
            <section class="hero-gradient text-white">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-20 text-center">
                    <h1 class="text-4xl md:text-6xl font-extrabold mb-4">Unlock Your Best Ideas</h1>
                    <p class="text-lg md:text-xl text-blue-100 mb-8 max-w-3xl mx-auto">The AI-powered academic partner that helps you brainstorm, structure essays, and understand complex topics. Go from blank page to brilliant idea in minutes.</p>
                    <button onclick="showPage('tutor')" class="bg-white text-blue-600 font-bold py-3 px-8 rounded-lg shadow-xl transition-transform transform hover:scale-105">Start Brainstorming</button>
                </div>
            </section>

             <section class="py-20 bg-gray-50">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-12">
                         <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900">A Smarter Way to Study</h2>
                         <p class="text-lg text-gray-600 mt-4 max-w-2xl mx-auto">Tools designed to enhance your learning and critical thinking.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-lg shadow-md text-center"><div class="text-4xl mb-4">🧠</div><h3 class="text-xl font-bold mb-2">Personalized Brainstorming</h3><p class="text-gray-600">Our AI uses your academic profile to generate tailored prompts that kickstart your thinking for any assignment.</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center"><div class="text-4xl mb-4">🎓</div><h3 class="text-xl font-bold mb-2">Prompt University</h3><p class="text-gray-600">Explore a library of novel prompts and high-quality AI answers to learn new ways of approaching complex subjects.</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center"><div class="text-4xl mb-4">💬</div><h3 class="text-xl font-bold mb-2">Collaborative Learning</h3><p class="text-gray-600">Generate a prompt, get an AI answer, and then share it in the Study Hall to get valuable feedback from your peers.</p></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- AI Tutor Page (Free & Pro) -->
        <div id="tutorPage" class="page-content">
             <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="max-w-4xl mx-auto">
                    
                    <!-- Free Version UI -->
                    <div id="freeVersionUI">
                        <div class="text-center pt-12 pb-8">
                            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4">AI Academic Prompt Generator</h1>
                            <p class="text-lg text-slate-600 mb-8 max-w-2xl mx-auto">What are you working on? Enter a topic to generate a personalized, academic prompt based on your student profile.</p>
                            <div class="max-w-xl mx-auto">
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <input type="text" id="searchInputFree" class="w-full px-4 py-3 rounded-lg border-2 border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="e.g., 'Causes of the Civil War', 'Photosynthesis'">
                                    <button onclick="handleFreeSearch()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex-shrink-0">Generate Prompt</button>
                                </div>
                            </div>
                        </div>
                        <div id="promptGeneratedState" class="hidden bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-slate-200 my-8">
                            <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border-l-4 border-blue-500 flex flex-col sm:flex-row items-center justify-between gap-4">
                               <div>
                                   <h3 class="font-bold text-blue-800">Upgrade to MyBrainstorm.ai Pro</h3>
                                   <p class="text-sm text-blue-700">Unlock your AI Tutor for interactive brainstorming, instant explanations, and audio summaries.</p>
                               </div>
                               <button onclick="switchToPro()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex-shrink-0">Unlock Pro</button>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-900 mb-2">Your Academic Prompt is Ready</h2>
                            <p class="text-slate-600 mb-4">Copy the text below and paste it into your favorite AI chat tool. Then, share both the prompt and the AI's answer in the <a href="#" onclick="showPage('hall')" class="text-blue-600 font-semibold underline">Study Hall</a> to get feedback from other students!</p>
                            <div class="prompt-cue-card bg-slate-100 p-4 rounded-lg border-2 border-slate-200 text-slate-700" id="promptCueCard"></div>
                            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                                <button onclick="resetFreeState()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition">Create Another</button>
                                <button onclick="copyPrompt()" class="bg-secondary text-white font-bold py-2 px-6 rounded-lg shadow-md flex items-center gap-2">Copy to Clipboard</button>
                            </div>
                        </div>
                    </div>

                    <!-- Pro Version UI -->
                    <div id="proVersionUI" class="hidden">
                        <div id="welcomeState" class="text-center py-12">
                            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4">Welcome to <span class="gradient-text">MyBrainstorm.ai Pro</span></h1>
                            <p class="text-lg text-slate-600 mb-8 max-w-2xl mx-auto">Your AI Tutor is ready. What subject are we tackling today?</p>
                             <div class="max-w-xl mx-auto">
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <input type="text" id="searchInputPro" class="w-full px-4 py-3 rounded-lg border-2 border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="e.g., 'Explain black holes', 'Outline an essay on Hamlet'">
                                    <button onclick="handleProSearch()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">Get Curated Prompt</button>
                                </div>
                            </div>
                        </div>
                         <div id="loadingState" class="hidden text-center py-20">
                             <div class="flex justify-center items-center space-x-2">
                                <div class="loader-dots"><div class="dot1 w-4 h-4 bg-blue-500 rounded-full"></div><div class="dot2 w-4 h-4 bg-blue-500 rounded-full"></div><div class="dot3 w-4 h-4 bg-blue-500 rounded-full"></div></div>
                                <p class="text-lg text-slate-600" id="loadingMessage">Researching...</p>
                            </div>
                        </div>
                        <div id="curatedPromptState" class="hidden bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-slate-200 my-8">
                            <h2 class="text-2xl font-bold text-slate-900 mb-2">Your Curated Prompt</h2>
                            <p class="text-slate-600 mb-4">We've created this starting point based on your student profile. Edit it for a more specific query.</p>
                            <textarea id="curatedPromptTextarea" class="w-full h-48 p-4 rounded-lg border-2 border-slate-200 bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition"></textarea>
                            <div class="mt-4 flex flex-col sm:flex-row justify-end gap-3">
                                <button onclick="resetProState()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition">Start Over</button>
                                <button onclick="getAdvice()" class="bg-secondary text-white font-bold py-2 px-6 rounded-lg shadow-md">Ask AI Tutor</button>
                            </div>
                        </div>
                        <div id="chatHistory" class="space-y-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prompt University Page -->
        <div id="universityPage" class="page-content">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="text-center mb-12"><h1 class="text-4xl md:text-5xl font-extrabold text-slate-900">Prompt University</h1><p class="text-lg text-slate-600 mt-4 max-w-2xl mx-auto">A library of novel prompts and high-quality AI answers to inspire your learning.</p></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="blogPosts"></div>
            </div>
        </div>

        <!-- Study Hall Page -->
        <div id="hallPage" class="page-content">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                 <div class="text-center mb-12"><h1 class="text-4xl md:text-5xl font-extrabold text-slate-900">Study Hall</h1><p class="text-lg text-slate-600 mt-4 max-w-2xl mx-auto">Share your generated prompts and AI answers to get feedback and learn from your peers.</p></div>
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white p-8 rounded-lg shadow-md mb-8">
                        <h3 class="text-2xl font-bold mb-4">Post for Feedback</h3>
                         <div class="space-y-4">
                            <input type="text" id="topicTitle" placeholder="Post title (e.g., 'Feedback on my essay outline?')" class="w-full p-2 border border-slate-300 rounded-md">
                            <textarea id="topicContent" rows="6" placeholder="Paste your prompt and the AI's answer here. Ask for specific feedback!" class="w-full p-2 border border-slate-300 rounded-md"></textarea>
                            <button onclick="postTopic()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Post to Study Hall</button>
                        </div>
                    </div>
                    <div id="messageBoard" class="space-y-6"></div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Onboarding Modal -->
     <div id="onboardingModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform scale-95 transition-all duration-300">
             <div class="p-6 sm:p-8 relative">
                <button onclick="closeOnboarding()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                <div class="text-center mb-6"><h2 class="text-2xl font-bold text-slate-900">Welcome to MyBrainstorm.ai</h2><p class="text-slate-600">Let's set up your student profile in 3 steps.</p></div>
                <div class="h-2 w-full bg-gray-200 rounded-full mb-6"><div id="progressFill" class="h-2 bg-blue-600 rounded-full transition-all duration-300" style="width: 33.3%;"></div></div>
                <div id="onboardingSteps">
                    <div id="step1" class="step active">
                        <h3 class="text-xl font-semibold text-center mb-4">Your Academic Level</h3>
                        <div class="space-y-4">
                            <input type="text" id="userName" placeholder="Your Name" class="w-full p-2 border border-slate-300 rounded-md">
                            <select id="academicLevel" class="w-full p-2 border border-slate-300 rounded-md bg-white"><option value="">I am a...</option><option value="High School Student">High School Student</option><option value="Undergraduate Student">Undergraduate Student</option><option value="Graduate Student">Graduate Student</option><option value="Doctoral Candidate">Doctoral Candidate</option><option value="Lifelong Learner">Lifelong Learner</option></select>
                            <input type="text" id="fieldOfStudy" placeholder="Field of Study (e.g., History, Biology)" class="w-full p-2 border border-slate-300 rounded-md">
                        </div>
                    </div>
                    <div id="step2" class="step">
                        <h3 class="text-xl font-semibold text-center mb-4">Your Learning Style</h3>
                        <div class="space-y-4">
                           <select id="primaryTask" class="w-full p-2 border border-slate-300 rounded-md bg-white"><option value="">I mostly need help with...</option><option value="Essay Writing">Essay Writing</option><option value="Research & Analysis">Research & Analysis</option><option value="Solving Problems">Solving Problems (STEM)</option><option value="Creative Projects">Creative Projects</option><option value="Studying & Summarizing">Studying & Summarizing</option></select>
                           <select id="learningStyle" class="w-full p-2 border border-slate-300 rounded-md bg-white"><option value="">My learning style is...</option><option value="Visual">Visual</option><option value="Auditory">Auditory</option><option value="Reading/Writing">Reading/Writing</option><option value="Kinesthetic">Kinesthetic</option></select>
                        </div>
                    </div>
                    <div id="step3" class="step">
                        <h3 class="text-xl font-semibold text-center mb-4">Your Goals</h3>
                        <div class="space-y-4">
                            <select id="primaryGoal" class="w-full p-2 border border-slate-300 rounded-md bg-white"><option value="">My primary goal is to...</option><option value="Brainstorm initial ideas">Brainstorm initial ideas</option><option value="Structure my arguments">Structure my arguments</option><option value="Understand a complex topic">Understand a complex topic</option><option value="Check my work for errors">Check my work for errors</option></select>
                            <textarea id="currentAssignment" rows="3" placeholder="What's a specific assignment you're working on? (Optional)" class="mt-4 w-full p-2 border border-slate-300 rounded-md"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 rounded-b-2xl flex justify-between items-center">
                <div class="text-sm font-medium text-slate-500">Step <span id="currentStep">1</span> of 3</div>
                <div><button id="prevBtn" onclick="previousStep()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition mr-2 hidden">Back</button><button id="nextBtn" onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">Next</button></div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-900 text-white py-2 px-5 rounded-lg shadow-xl translate-x-[calc(100%+2rem)] transition-transform duration-300"><p id="toastMessage"></p></div>

    <script>
        // --- GLOBAL STATE ---
        let userProfile = {}; let chatHistory = []; let currentOnboardingStep = 1; let isPro = false;
        
        // --- SAMPLE DATA ---
        const sampleBlogPosts = [{title:'Prompting for a Perfect Thesis Statement',content:'Learn how to guide an AI to generate a strong, arguable thesis for any essay.',image:'🎓'},{title:'Using AI to Analyze Historical Documents',content:'A step-by-step guide to creating prompts that extract key insights from primary sources.',image:'📜'},{title:'Brainstorming STEM Solutions with AI',content:'Move beyond simple answers and use AI to explore novel solutions to complex scientific problems.',image:'🔬'}];
        const sampleThreads = [{title:'Feedback on my AI-generated essay outline for "The Great Gatsby"?',author:'LitLover22',content:"Hey everyone, I used the prompt generator to get an outline for my paper. Does this structure make sense? Is there anything I'm missing? [Paste of prompt and AI answer]...",replies:12,time:'1 hour ago'},{title:'My AI tutor is confused about quantum mechanics. Help!',author:'PhysNerd',content:"I asked the AI to explain quantum entanglement and it gave me a weird analogy. Can anyone who understands this stuff check the AI's answer? [Paste of prompt and AI answer]...",replies:25,time:'3 hours ago'}];

        // --- PAGE & TIER MANAGEMENT ---
        function showPage(page) {
            document.querySelectorAll('.page-content').forEach(p=>p.classList.remove('active'));
            document.getElementById(`${page}Page`).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
            const navId = {home:'nav-home',tutor:'nav-tutor',university:'nav-university',hall:'nav-hall'}[page];
            document.getElementById(navId).classList.add('active');
            window.scrollTo(0, 0);
            if(page === 'tutor') renderAdvisorPage();
        }
        function switchToPro() {
            isPro = true; localStorage.setItem('mybrainstormPro', 'true'); renderAdvisorPage(); showToast("Pro Version Activated!");
        }
        function renderAdvisorPage() {
            if (isPro) {
                document.getElementById('freeVersionUI').style.display = 'none';
                document.getElementById('proVersionUI').style.display = 'block';
                resetProState();
            } else {
                document.getElementById('freeVersionUI').style.display = 'block';
                document.getElementById('proVersionUI').style.display = 'none';
                resetFreeState();
            }
        }

        // --- ONBOARDING LOGIC ---
        function showOnboarding(){document.getElementById('onboardingModal').classList.remove('opacity-0','pointer-events-none');document.querySelector('#onboardingModal > div').classList.remove('scale-95')}
        function closeOnboarding(){document.getElementById('onboardingModal').classList.add('opacity-0','pointer-events-none');document.querySelector('#onboardingModal > div').classList.add('scale-95')}
        function nextStep(){if(currentOnboardingStep<3){currentOnboardingStep++;document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));document.getElementById(`step${currentOnboardingStep}`).classList.add('active');updateOnboardingUI()}else{saveProfile();closeOnboarding();showToast("Your student profile is all set!")}}
        function previousStep(){if(currentOnboardingStep>1){currentOnboardingStep--;document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));document.getElementById(`step${currentOnboardingStep}`).classList.add('active');updateOnboardingUI()}}
        function updateOnboardingUI(){document.getElementById('currentStep').innerText=currentOnboardingStep;document.getElementById('progressFill').style.width=`${currentOnboardingStep/3*100}%`;document.getElementById('prevBtn').classList.toggle('hidden',currentOnboardingStep===1);document.getElementById('nextBtn').innerText=currentOnboardingStep===3?'Finish':'Next'}
        function saveProfile(){userProfile={name:document.getElementById('userName').value,academicLevel:document.getElementById('academicLevel').value,fieldOfStudy:document.getElementById('fieldOfStudy').value,primaryTask:document.getElementById('primaryTask').value,learningStyle:document.getElementById('learningStyle').value,primaryGoal:document.getElementById('primaryGoal').value,currentAssignment:document.getElementById('currentAssignment').value};localStorage.setItem('mybrainstormProfile',JSON.stringify(userProfile))}
        function loadProfile(){const e=localStorage.getItem('mybrainstormProfile');if(e){userProfile=JSON.parse(e);Object.keys(userProfile).forEach(e=>{const t=document.getElementById(e);if(t)t.value=userProfile[e]})}else setTimeout(showOnboarding,1500)}
        
        // --- UI & CONTENT RENDERING ---
        function showToast(e){const t=document.getElementById('toast');t.innerText=e;t.classList.remove('translate-x-[calc(100%+2rem)]');setTimeout(()=>{t.classList.add('translate-x-[calc(100%+2rem)]')},3e3)}
        function loadBlogPosts() {
            const container = document.getElementById('blogPosts');
            container.innerHTML = sampleBlogPosts.map(post => `<div class="bg-white rounded-lg shadow-md overflow-hidden transition-transform transform hover:-translate-y-1"><div class="h-40 hero-gradient flex items-center justify-center text-5xl">${post.image}</div><div class="p-6"><h3 class="text-xl font-bold mt-2 mb-2 text-gray-800">${post.title}</h3><p class="text-gray-600">${post.content}</p></div></div>`).join('');
        }
        function loadMessageBoard() {
            const board = document.getElementById('messageBoard');
            board.innerHTML = sampleThreads.map(t => `<div class="bg-white p-6 rounded-lg shadow-md"><h4 class="font-bold text-lg">${t.title}</h4><p class="text-sm text-slate-500 mb-2">by ${t.author} • ${t.time} • ${t.replies} replies</p><p class="text-slate-600">${t.content}</p></div>`).join('');
        }
        function postTopic() {
            const title = document.getElementById('topicTitle').value;
            const content = document.getElementById('topicContent').value;
            if (!title || !content) return showToast('Please fill all fields');
            sampleThreads.unshift({ title, author: userProfile.name || 'Anonymous', content, replies: 0, time: 'Just now' });
            loadMessageBoard();
            document.getElementById('topicTitle').value = ''; document.getElementById('topicContent').value = '';
            showToast('Posted to Study Hall successfully!');
        }
        
        // --- FREE VERSION LOGIC ---
        function setFreeState(state) { document.getElementById('promptGeneratedState').style.display = state === 'generated' ? 'block' : 'none'; }
        function resetFreeState() { setFreeState('initial'); document.getElementById('searchInputFree').value = ''; }
        function handleFreeSearch() {
            const keyword = document.getElementById('searchInputFree').value;
            if (!keyword) return showToast("Please enter an academic topic.");
            if (Object.keys(userProfile).length < 5) { showOnboarding(); return showToast("Please complete your student profile first!"); }
            const prompt = `I am a ${userProfile.academicLevel || 'student'} studying ${userProfile.fieldOfStudy || 'my subject'}. I am currently working on "${keyword}" and my primary task is ${userProfile.primaryTask || 'understanding the material'}.\n\nMy main goal is to ${userProfile.primaryGoal || 'brainstorm ideas'}. Please act as an expert academic tutor and generate a detailed set of brainstorming questions, a structured outline, or a clear explanation for this topic, tailored to my academic level and learning style (${userProfile.learningStyle || 'balanced'}). The response should be comprehensive and aimed at fostering deeper understanding.`;
            document.getElementById('promptCueCard').textContent = prompt;
            setFreeState('generated');
        }
        function copyPrompt() {
            const promptText = document.getElementById('promptCueCard').textContent;
            navigator.clipboard.writeText(promptText).then(() => showToast('Prompt copied to clipboard!'));
        }

        // --- PRO VERSION (GEMINI API) LOGIC ---
        function setProState(e,t=""){['welcomeState','loadingState','curatedPromptState'].forEach(e=>{document.getElementById(e).style.display='none'});document.getElementById('chatHistory').style.display='none';switch(e){case'loading':document.getElementById('loadingState').style.display='block';document.getElementById('loadingMessage').innerText=t;break;case'prompt':case'chat':document.getElementById('curatedPromptState').style.display='block';document.getElementById('chatHistory').style.display='block';break;default:document.getElementById('welcomeState').style.display='block'}}
        function resetProState(){chatHistory=[];renderChatHistory();setProState('welcome')}
        async function callGeminiAPI(e,t,n=3,o=1e3){const i="AIzaSyDkBHWGERIoYNeK00O_n15Uj76KEzNvpAE";const l=`https://generativelanguage.googleapis.com/v1beta/models/${e}:generateContent?key=${i}`;try{const e=await fetch(l,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(t)});if(!e.ok){if(e.status===429&&n>0){await new Promise(e=>setTimeout(e,o));return callGeminiAPI(e,t,n-1,o*2)}throw new Error(`API Error: ${e.statusText}`)}return await e.json()}catch(e){console.error("API Call failed:",e);showToast("An API error occurred.");setProState('welcome');return null}}
        async function handleProSearch() {
            const keyword = document.getElementById('searchInputPro').value;
            if (!keyword) return showToast("Please enter a topic.");
            setProState('loading', 'Crafting a scholarly prompt...');
            const systemInstruction = `You are an expert academic prompt engineer. Based on the student's profile and their topic, create a detailed, Socratic-style prompt to guide an AI Tutor. The prompt should encourage critical thinking, not just information retrieval.`;
            const userQuery = `Student Profile: ${JSON.stringify(userProfile)}\nTopic: "${keyword}"\n\nGenerate the prompt.`;
            const payload = { systemInstruction: { parts: [{ text: systemInstruction }] }, contents: [{ parts: [{ text: userQuery }] }] };
            const result = await callGeminiAPI('gemini-2.5-flash-preview-05-20', payload);
            if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
                document.getElementById('curatedPromptTextarea').value = result.candidates[0].content.parts[0].text;
                setProState('prompt');
            } else { showToast("Could not create a prompt."); setProState('welcome'); }
        }
        async function getAdvice() {
            const userPrompt = document.getElementById('curatedPromptTextarea').value;
            chatHistory.push({ role: 'user', parts: [{ text: userPrompt }] });
            renderChatHistory();
            setProState('loading', 'AI Tutor is thinking...');
            const systemInstruction = "You are MyBrainstorm.ai, an expert AI academic tutor. Your tone is encouraging, knowledgeable, and Socratic. You are to act as a guide, helping students explore topics, structure arguments, and understand complex ideas. Never give the direct answer. Instead, ask probing questions and provide frameworks for thinking. Tailor your guidance to the student's academic profile.";
            const payload = { systemInstruction: { parts: [{ text: systemInstruction }] }, contents: chatHistory };
            const result = await callGeminiAPI('gemini-2.5-flash-preview-05-20', payload);
            if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
                const modelResponse = result.candidates[0].content.parts[0].text;
                chatHistory.push({ role: 'model', parts: [{ text: modelResponse }] });
                renderChatHistory();
                setProState('chat');
            } else { showToast("Sorry, I'm having a moment of brain-freeze!"); chatHistory.pop(); renderChatHistory(); setProState('prompt'); }
        }
        function renderChatHistory() {
            const container = document.getElementById('chatHistory');
            container.innerHTML = chatHistory.map((turn, index) => {
                const isUser = turn.role === 'user';
                const avatar = isUser ? `<div class="w-10 h-10 rounded-full bg-secondary flex items-center justify-center font-bold text-white">You</div>` : `<div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-2xl">💡</div>`;
                const contentBg = isUser ? 'bg-green-100' : 'bg-white';
                const content = turn.parts[0].text.replace(/\n/g, '<br>');
                const audioBtn = !isUser ? `<div class="mt-3"><button id="audioBtn_${index}" onclick="playAudio(this, ${index})" class="text-sm font-semibold text-blue-600 hover:text-blue-800 flex items-center gap-1">▶ Listen to Explanation</button></div>` : '';
                return `<div class="flex items-start gap-4 ${isUser ? 'justify-end' : ''}">${!isUser ? avatar : ''}<div class="${contentBg} p-4 rounded-xl max-w-xl shadow-md border border-slate-100"><div class="response-text">${content}</div>${audioBtn}</div>${isUser ? avatar : ''}</div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }
        function base64ToArrayBuffer(b){const c=window.atob(b),d=c.length,e=new Uint8Array(d);for(let a=0;a<d;a++)e[a]=c.charCodeAt(a);return e.buffer}function pcmToWav(e,f){const g=new ArrayBuffer(44),a=new DataView(g);function h(a,b,c){for(let d=0;d<c.length;d++)a.setUint8(b+d,c.charCodeAt(d))}return h(a,0,"RIFF"),a.setUint32(4,36+2*e.length,!0),h(a,8,"WAVE"),h(a,12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,1,!0),a.setUint32(24,f,!0),a.setUint32(28,2*f,!0),a.setUint16(32,2,!0),a.setUint16(34,16,!0),h(a,36,"data"),a.setUint32(40,2*e.length,!0),b=new Int16Array(44+2*e.length),b.set(new Int16Array(g),0),b.set(e,22),new Blob([b],{type:"audio/wav"})}
        async function playAudio(button, index) {
            button.innerHTML = '...'; button.disabled = true;
            const textToPlay = chatHistory[index].parts[0].text;
            const payload = {contents: [{ parts: [{ text: `Say in a clear, encouraging, and knowledgeable tone: ${textToPlay}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Charon" } } } }, model: "gemini-2.5-flash-preview-tts"};
            const result = await callGeminiAPI('gemini-2.5-flash-preview-tts', payload);
            if (result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data) {
                const data = result.candidates[0].content.parts[0].inlineData, sampleRate = parseInt(data.mimeType.match(/rate=(\d+)/)[1], 10);
                const pcm16 = new Int16Array(base64ToArrayBuffer(data.data)), wavBlob = pcmToWav(pcm16, sampleRate);
                const audio = new Audio(URL.createObjectURL(wavBlob));
                audio.play(); button.innerHTML = '❚❚ Playing...'; audio.onended = () => { button.innerHTML = '▶ Listen to Explanation'; };
            } else { showToast("Could not generate audio."); button.innerHTML = '▶ Listen to Explanation'; }
            button.disabled = false;
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            isPro = localStorage.getItem('mybrainstormPro') === 'true';
            showPage('home');
            loadProfile(); loadBlogPosts(); loadMessageBoard();
        });
    </script>
</body>
</html>

